// ==============================================
// SISTEMA DE RESPALDO ROBUSTO - FT-MEP
// ==============================================

class BackupManager {
    constructor() {
        this.config = {
            backupInterval: 30 * 60 * 1000, // 30 minutos
            maxBackups: 10,
            autoBackup: true,
            backupTypes: ['localStorage', 'indexedDB', 'file']
        };
        
        this.dbName = 'ft_mep_backup';
        this.dbVersion = 1;
        this.db = null;
        
        this.init();
    }
    
    async init() {
        console.log('üíæ Inicializando sistema de respaldo...');
        
        try {
            // 1. Inicializar IndexedDB
            await this.initIndexedDB();
            
            // 2. Verificar datos existentes
            await this.verificarIntegridadDatos();
            
            // 3. Configurar respaldo autom√°tico
            if (this.config.autoBackup) {
                this.configurarRespaldoAutomatico();
            }
            
            // 4. Actualizar UI
            this.actualizarUIEstado();
            
            console.log('‚úÖ Sistema de respaldo inicializado');
            
        } catch (error) {
            console.error('‚ùå Error inicializando sistema de respaldo:', error);
            this.mostrarError('Sistema de respaldo no disponible');
        }
    }
    
    async initIndexedDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.dbName, this.dbVersion);
            
            request.onerror = (event) => {
                console.error('‚ùå Error abriendo IndexedDB:', event.target.error);
                reject(event.target.error);
            };
            
            request.onsuccess = (event) => {
                this.db = event.target.result;
                console.log('‚úÖ IndexedDB conectado');
                resolve();
            };
            
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                
                // Crear almac√©n para respaldos
                if (!db.objectStoreNames.contains('backups')) {
                    const store = db.createObjectStore('backups', { keyPath: 'id', autoIncrement: true });
                    store.createIndex('timestamp', 'timestamp', { unique: false });
                    store.createIndex('type', 'type', { unique: false });
                }
                
                // Crear almac√©n para datos de estudiantes
                if (!db.objectStoreNames.contains('estudiantes')) {
                    db.createObjectStore('estudiantes', { keyPath: 'id' });
                }
                
                // Crear almac√©n para calificaciones
                if (!db.objectStoreNames.contains('calificaciones')) {
                    const store = db.createObjectStore('calificaciones', { keyPath: ['estudianteId', 'mes'] });
                    store.createIndex('estudianteId', 'estudianteId', { unique: false });
                    store.createIndex('mes', 'mes', { unique: false });
                }
                
                console.log('üîÑ IndexedDB actualizado a versi√≥n', this.dbVersion);